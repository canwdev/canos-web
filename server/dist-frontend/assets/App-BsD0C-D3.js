var e=Object.defineProperty,a=(a,t,o)=>((a,t,o)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[t]=o)(a,"symbol"!=typeof t?t+"":t,o);import{ab as t,d as o,r as i,N as l,aH as r,l as s,O as d,aB as n,aY as c,o as u,c as v,b as m,n as h,a as g,f as p,aX as b,g as y,F as f,e as w,k,aZ as R,h as _}from"./index-Ch1CAwop.js";import{u as C}from"./use-cursor-uF34S_B5.js";class S{constructor(e){a(this,"videoElement"),a(this,"mediaRecorder"),a(this,"recordedChunks"),this.videoElement=e,this.mediaRecorder=null,this.recordedChunks=[],console.log("[VideoRecorder]",this)}start(){const e=this.videoElement.srcObject;this.mediaRecorder=new MediaRecorder(e,{audioBitsPerSecond:32e4,videoBitsPerSecond:8e6,mimeType:"video/webm"}),this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.recordedChunks.push(e.data)},this.mediaRecorder.onstop=()=>{console.log("record stop",this.mediaRecorder);const e=new Blob(this.recordedChunks,{type:"video/webm"}),a=URL.createObjectURL(e),o=document.createElement("a");o.href=a,o.download=`record_${t().format("YYYY-MM-DD_HH-mm-ss")}.webm`,o.click(),this.mediaRecorder=null},this.recordedChunks=[],this.mediaRecorder.start(10),console.log("record start",this.mediaRecorder)}stop(){this.mediaRecorder&&this.mediaRecorder.stop()}}const D={class:"action-bar-wrap"},E={class:"action-bar-side"},I={for:"videoSelect"},M=m("span",null,"Video:",-1),U=["value"],j={for:"audioSelect"},Y=m("span",null,"Audio:",-1),x=["value"],H={for:"toggleControls",title:"Toggle video element controls"},O=m("span",null,"Controls",-1),B={class:"action-bar-side right"},L=m("a",{href:"https://github.com/canwdev/web-mediadevices-player",target:"_blank",title:"Github"},"ℹ️",-1),V=["controls"],T=o({__name:"App",setup(e){const a=i(!1),o=l("ls_key_is_show_controls",!1),T=i([]),A=i(),P=l("ls_key_video_device_id",""),F=l("ls_key_audio_device_id",""),G=l("ls_key_video_config",{}),W=r(),$=(e,a)=>e.filter((e=>e.kind===a&&!!e.deviceId)),z=s((()=>$(T.value,"videoinput"))),N=s((()=>$(T.value,"audioinput"))),X=async()=>{try{a.value=!0,T.value=await async function(){var e;if(null==(e=navigator.mediaDevices)?void 0:e.enumerateDevices)return await navigator.mediaDevices.enumerateDevices();throw new Error("enumerateDevices() not supported.")}()}catch(e){console.error(e),alert("Error: "+e.message)}finally{a.value=!1}},Z=()=>{navigator.mediaDevices.ondevicechange=async()=>{await X()}},q=r(),J=r();C(J,(({el:e,isShow:a})=>{const t=q.value;a?(e.style.cursor="",t.classList.add("visible")):(e.style.cursor="none",t.classList.remove("visible"))}),3e3),d((async()=>{try{if(P.value||F.value)return await K(),await X(),void Z();try{W.value=await navigator.mediaDevices.getUserMedia({audio:!0}),ee()}catch(e){console.warn("getUserMedia audio Error:",e)}try{W.value=await navigator.mediaDevices.getUserMedia({video:!0}),ee()}catch(e){console.warn("getUserMedia video Error:",e)}await X(),Z()}catch(e){console.error(e),alert("Error: "+e.message)}})),n((()=>{ee()}));const K=async()=>{try{a.value=!0;const t=P.value,o=F.value;let i;if(t)if(G.value&&G.value.deviceId===t)i=G.value;else{const e=z.value.find((e=>e.deviceId===t));if(console.log(e),e){const a=e.getCapabilities();i=G.value={deviceId:a.deviceId,height:a.height.max,width:a.width.max,frameRate:a.frameRate.max}}else i={deviceId:t}}var e={audio:!!o&&{deviceId:o,autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1},video:i};const l=await navigator.mediaDevices.getUserMedia(e);W.value=l;const r=A.value;r.srcObject=l,r.onloadedmetadata=()=>{r.play()}}catch(t){console.error(t),alert("Error: "+t.message)}finally{a.value=!1}},Q=()=>{ee(),K()},ee=()=>{const e=A.value;e.pause(),e.srcObject=null;const a=W.value;if(!a)return;a.getTracks().forEach((e=>{"live"==e.readyState&&e.stop()}))},ae=()=>{ee(),P.value="",F.value="",G.value=null},{toggle:te}=c(J),oe=async()=>{try{a.value=!0,ee();const e=await navigator.mediaDevices.getDisplayMedia({video:{displaySurface:"window"},audio:!0});W.value=e;const t=A.value;t.srcObject=e,t.onloadedmetadata=()=>{t.play()}}catch(e){console.error(e),alert("Error: "+e.message)}finally{a.value=!1}},ie=()=>{!function(e){const a=document.createElement("canvas");a.width=e.videoWidth,a.height=e.videoHeight,a.getContext("2d").drawImage(e,0,0,e.videoWidth,e.videoHeight);const o=a.toDataURL("image/png"),i=document.createElement("a");i.download=`screenshot_${t().format("YYYY-MM-DD_HH-mm-ss")}.png`,i.href=o,i.click()}(A.value)};let le=i(null);return d((()=>{le.value=new S(A.value)})),(e,t)=>(u(),v("div",{ref_key:"rootRef",ref:J,class:"web-mediadevices-player"},[m("div",{class:h(["loading-layer",{visible:a.value}])},"Loading...",2),m("div",D,[m("div",{ref_key:"actionBarRef",ref:q,class:h(["action-bar font-emoji",{visible:!g(P)&&!g(F)}])},[m("div",E,[m("label",I,[M,p(m("select",{title:"Video",id:"videoSelect","onUpdate:modelValue":t[0]||(t[0]=e=>y(P)?P.value=e:null)},[(u(!0),v(f,null,w(z.value,(e=>(u(),v("option",{key:e.deviceId,value:e.deviceId},k(e.label),9,U)))),128))],512),[[b,g(P)]])]),m("label",j,[Y,p(m("select",{name:"Audio",id:"audioSelect","onUpdate:modelValue":t[1]||(t[1]=e=>y(F)?F.value=e:null)},[(u(!0),v(f,null,w(N.value,(e=>(u(),v("option",{key:e.deviceId,value:e.deviceId},k(e.label),9,x)))),128))],512),[[b,g(F)]])]),m("button",{onClick:Q},"▶Start"),m("button",{onClick:ee},"⏹Stop"),m("button",{onClick:ae},"🛑Reset"),m("label",H,[p(m("input",{id:"toggleControls",type:"checkbox","onUpdate:modelValue":t[2]||(t[2]=e=>y(o)?o.value=e:null),title:"Show Controls"},null,512),[[R,g(o)]]),O]),m("button",{onClick:oe,title:"Capture Screen"},"🖥️Capture..."),m("button",{onClick:ie,title:"Take a photo"},"📷Screenshot"),g(le)?(u(),v(f,{key:0},[Boolean(g(le).mediaRecorder)?(u(),v("button",{key:0,onClick:t[3]||(t[3]=e=>g(le).stop()),title:"Save record",style:{background:"#f44336"}}," 📹Save ")):(u(),v("button",{key:1,onClick:t[4]||(t[4]=e=>g(le).start()),title:"Record canvas"},"📹Record..."))],64)):_("",!0)]),m("div",B,[m("button",{onClick:t[5]||(t[5]=(...e)=>g(te)&&g(te)(...e))},"📺Fullscreen"),L])],2)]),m("video",{ref_key:"videoRef",ref:A,id:"videoId",autoplay:"",playsinline:"",controls:g(o)},null,8,V)],512))}});export{T as default};
