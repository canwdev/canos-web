import{bi as e,r as a,k as l,M as t,_ as n,o as s,c as o,b as r,g as i,t as u,n as c,c5 as d,d as v,bE as y,D as p,l as b,a1 as m,w as T,b1 as f,c6 as E,F as C,e as P,Z as k}from"./index-CKZunzLP.js";var O=(e=>(e[e.SEMITONE=12]="SEMITONE",e[e.KEY_COUNT=88]="KEY_COUNT",e))(O||{}),w=(e=>(e[e.HIDDEN=-1]="HIDDEN",e[e.WHITE=0]="WHITE",e[e.BLACK=1]="BLACK",e[e.CUSTOM=2]="CUSTOM",e))(w||{});const x=[{isMP3:!1,value:"sine",label:"正弦波(sine)"},{isMP3:!1,value:"square",label:"方波(square)"},{isMP3:!1,value:"sawtooth",label:"锯齿波(sawtooth)"},{isMP3:!1,value:"triangle",label:"三角波(triangle)"},{isMP3:!0,value:"pianoKeyAudio",label:"钢琴原声(LowRes)"},{isMP3:!0,value:"pianoKeyAudioFL",label:"钢琴原声(FL)"}],K=[{label:"A",type:0},{label:"W",type:1},{label:"S",type:0},{label:"E",type:1},{label:"D",type:0},{label:"F",type:0},{label:"T",type:1},{label:"G",type:0},{label:"Y",type:1},{label:"H",type:0},{label:"U",type:1},{label:"J",type:0},{label:"K",type:0},{label:"O",type:1},{label:"L",type:0},{label:"P",type:1},{label:";",type:0},{label:"'",type:0}],g=[{label:"Z",extraLabel:"﹣",type:2},{label:"X",extraLabel:"﹢",type:2},{label:"C",extraLabel:"﹣",type:2},{label:"V",extraLabel:"﹢",type:2}];[1,2,3,4,5,6,7].forEach((e=>{g.push({label:e.toString(),extraLabel:"",type:-1})}));const h={props:{keyType:{type:Number,default:w.WHITE},label:{type:String,default:""},extraLabel:{type:String,default:""},active:{type:Boolean,default:!1},small:{type:Boolean,default:!1}},emits:["onPress","onRelease"],setup(n,{emit:s}){const{active:o}=e(n),r=a(),i=a(!1);l(o,(e=>{i.value=e}));const u=e=>{1===e.buttons&&(i.value||(s("onPress",r.value),i.value=!0))},c=()=>{i.value&&(s("onRelease",r.value),i.value=!1)};return t((()=>{const e=r.value;e.addEventListener("mousedown",u),e.addEventListener("mouseup",c),e.addEventListener("mouseover",u),e.addEventListener("mouseleave",c)})),{pressed:i,buttonRef:r}}},A={class:"inner"};const M=n(h,[["render",function(e,a,l,t,n,d){return s(),o("button",{ref:"buttonRef",class:c(["key",{black:1===l.keyType,custom:2===l.keyType,hidden:-1===l.keyType,pressed:t.pressed,small:l.small}])},[r("span",A,[i(u(l.label)+" ",1),r("sub",null,u(l.extraLabel),1)])],2)}],["__scopeId","data-v-56dda1d1"]]),I=d.create({});function L(e,a){return new Promise(((l,t)=>{I.get(a,{responseType:"arraybuffer"}).then((a=>{e.decodeAudioData(a.data,(e=>{e?l(e):t()}))})).catch((e=>{t(e)}))}))}const S=function(){let e=[];for(let a=0;a<9;a++)e[a]=[];return e[0].A=27.5,e[0]["A#"]=29.13523509488062,e[0].B=30.867706328507754,e[1].C=32.70319566257483,e[1]["C#"]=34.64782887210901,e[1].D=36.70809598967595,e[1]["D#"]=38.890872965260115,e[1].E=41.20344461410874,e[1].F=43.653528929125486,e[1]["F#"]=46.2493028389543,e[1].G=48.99942949771866,e[1]["G#"]=51.91308719749314,e[1].A=55,e[1]["A#"]=58.27047018976124,e[1].B=61.735412657015516,e[2].C=65.40639132514966,e[2]["C#"]=69.29565774421802,e[2].D=73.4161919793519,e[2]["D#"]=77.78174593052023,e[2].E=82.40688922821748,e[2].F=87.30705785825097,e[2]["F#"]=92.4986056779086,e[2].G=97.99885899543732,e[2]["G#"]=103.82617439498628,e[2].A=110,e[2]["A#"]=116.54094037952248,e[2].B=123.47082531403103,e[3].C=130.8127826502993,e[3]["C#"]=138.59131548843604,e[3].D=146.8323839587038,e[3]["D#"]=155.56349186104046,e[3].E=164.81377845643496,e[3].F=174.61411571650194,e[3]["F#"]=184.9972113558172,e[3].G=195.99771799087463,e[3]["G#"]=207.65234878997256,e[3].A=220,e[3]["A#"]=233.08188075904496,e[3].B=246.94165062806206,e[4].C=261.6255653005986,e[4]["C#"]=277.1826309768721,e[4].D=293.6647679174076,e[4]["D#"]=311.1269837220809,e[4].E=329.6275569128699,e[4].F=349.2282314330039,e[4]["F#"]=369.9944227116344,e[4].G=391.99543598174927,e[4]["G#"]=415.3046975799451,e[4].A=440,e[4]["A#"]=466.1637615180899,e[4].B=493.8833012561241,e[5].C=523.2511306011972,e[5]["C#"]=554.3652619537442,e[5].D=587.3295358348151,e[5]["D#"]=622.2539674441618,e[5].E=659.2551138257398,e[5].F=698.4564628660078,e[5]["F#"]=739.9888454232688,e[5].G=783.9908719634985,e[5]["G#"]=830.6093951598903,e[5].A=880,e[5]["A#"]=932.3275230361799,e[5].B=987.7666025122483,e[6].C=1046.5022612023945,e[6]["C#"]=1108.7305239074883,e[6].D=1174.6590716696303,e[6]["D#"]=1244.5079348883237,e[6].E=1318.5102276514797,e[6].F=1396.9129257320155,e[6]["F#"]=1479.9776908465376,e[6].G=1567.981743926997,e[6]["G#"]=1661.2187903197805,e[6].A=1760,e[6]["A#"]=1864.6550460723597,e[6].B=1975.5332050244965,e[7].C=2093.004522404789,e[7]["C#"]=2217.4610478149766,e[7].D=2349.3181433392606,e[7]["D#"]=2489.0158697766474,e[7].E=2637.0204553029594,e[7].F=2793.825851464031,e[7]["F#"]=2959.955381693075,e[7].G=3135.963487853994,e[7]["G#"]=3322.437580639561,e[7].A=3520,e[7]["A#"]=3729.3100921447194,e[7].B=3951.066410048993,e[8].C=4186.009044809578,e}(),F=(e,t=0)=>{const n=a(Number(localStorage.getItem(e))||t);return l(n,(a=>{a?localStorage.setItem(e,String(a)):localStorage.removeItem(e)})),n},D=v({name:"App",components:{PianoKey:M},setup(){const e=a(),n=a(),s=a([]),o=y(),r=y(),i=y(),u=F("KEY_OFFSET",52),c=a([]),d=a([]),v=a([]),m=a(0),T=a(),f=F("VOLUME",1),E=((e,t="")=>{const n=a(localStorage.getItem(e)||t);return l(n,(a=>{a?localStorage.setItem(e,a):localStorage.removeItem(e)})),n})("selectedToneType","sine");l(f,(e=>{o.value.gain.value=e.toFixed(1)}));const C=()=>{const e=s.value[R.value];e&&n.value.scrollTo({left:e.offsetLeft-50,behavior:"smooth"})};l(u,(()=>{C()})),l(E,(e=>{localStorage.setItem("selectedToneType",e),h(),k()}));const P=p((()=>x.filter((e=>e.value===E.value))[0].isMP3||!1)),k=async()=>{const e=window.AudioContext||window.webkitAudioContext||!1;if(e||alert("您的浏览器不支持 Web Audio API，程序无法正常运作"),r.value=new e,o.value=r.value.createGain(),o.value.gain.value=f.value,c.value=[],d.value=[],T.value=null,i.value=r.value.createAnalyser(),i.value.connect(r.value.destination),P.value)for(let a=1;a<=O.KEY_COUNT;a++)c.value[a]=await L(r.value,`/canos-webtones/${E.value}/${a}.mp3`).catch((e=>{console.error(e)})),m.value=a;else{let e=1;S.forEach((a=>{Object.entries(a).forEach((([a,l])=>{c.value[e]=l,m.value=e,e++}))}))}window.addEventListener("keydown",D),window.addEventListener("keyup",D),C()},h=()=>{window.removeEventListener("keydown",D),window.removeEventListener("keyup",D),r.value=null},A=(e,a)=>{clearTimeout(T.value);let l=null;const t=r.value;P.value?(l=t.createBufferSource(),l.buffer=e):(l=t.createOscillator(),l.type=E.value,l.frequency.value=e);const n=t.createGain();return l.connect(n),P.value||(n.gain.exponentialRampToValueAtTime(1,t.currentTime),n.gain.exponentialRampToValueAtTime(1e-4,t.currentTime+1.5)),n.connect(o.value),o.value.connect(i.value),l.start(t.currentTime),d.value[a]={audio:l,gainNode:n},l},M=e=>{clearTimeout(T.value);const a=d.value[e];a?(a.gainNode.gain.exponentialRampToValueAtTime(1e-4,r.value.currentTime+1),T.value=setTimeout((()=>{a.audio.stop(),d.value[e]=null}),1e3)):console.warn("stopTone: named tone not exist: "+e)},I=e=>{let a=e+u.value;const l=c.value[a];l?A(l,e):console.warn("[handleMainKeyboardPress]: index tone not exist: "+a+", The name is "+e)},D=e=>{const a=e.key.toUpperCase(),l=K.findIndex((e=>e.label===a)),t=g.findIndex((e=>e.label===a));if(-1!==l||-1!==t){const l=v.value.indexOf(a);if("keydown"===e.type){if(-1!==l)return;v.value.push(a)}else-1!==l&&v.value.splice(l,1)}-1!==l&&("keydown"===e.type?I(l):M(l)),-1!==t&&"keyup"===e.type&&N(a)},N=e=>{switch(e){case"Z":u.value=Math.max(4,u.value-O.SEMITONE);break;case"X":u.value=Math.min(76,u.value+O.SEMITONE);break;case"C":f.value=Math.max(0,f.value-.1);break;case"V":f.value=Math.min(1,f.value+.1)}/[1-9]/.test(e)&&(u.value=(Number(e)-1)*O.SEMITONE+4)};t((async()=>{"ontouchstart"in window&&alert("请使用鼠标或键盘输入"),await k()})),b((()=>{h()}));const R=p((()=>Math.floor(u.value/O.SEMITONE)+1)),G=p((()=>{let e=0,a=[];for(let l=0;l<S.length;l++){const t=Object.entries(S[l]);let n=[];for(let a=0;a<t.length;a++){const[l,s]=t[a];n.push({label:l,value:s,realIndex:e}),e++}a.push(n)}return a}));return{rootRef:e,miniKeyboardRef:n,miniKeyboardOctavesRef:s,PianoConstant:O,KeyType:w,ToneTypesOptions:x,pianoNoteTable:S,MainKeyboardKeys:K,ControlKeys:g,loadingCount:m,keyOffset:u,keyPressedPC:v,octave:R,handleMainKeyboardPress:I,selectedToneType:E,volume:f,handleMiniKeyboardPress:e=>{const a=c.value[e];a?A(a,e):console.warn("handleMiniKeyboardPress: index tone not exist: "+e)},stopTone:M,setSettings:N,miniKeys:G}}}),N={ref:"rootRef",class:"piano-js-wrap"},R={class:"piano-loading"},G={class:"piano-body"},B={class:"info-wrap"},_={class:"desc"},U={class:"desc"},Y={class:"desc pro"},H={class:"desc pro3"},V=["value","disabled"],W={class:"mini-keyboard-wrap",ref:"miniKeyboardRef"},j={class:"main-keyboard-wrap"},q={class:"control-wrap"};const Z=n(D,[["render",function(e,a,l,t,n,d){const v=m("PianoKey");return s(),o("div",N,[T(r("div",R,[r("p",null,"加载音频素材 "+u(e.loadingCount)+"/"+u(e.PianoConstant.KEY_COUNT),1)],512),[[f,e.loadingCount+1<=e.PianoConstant.KEY_COUNT]]),r("div",G,[r("div",B,[r("div",null,[r("div",_,"音量: "+u(100*Number(e.volume.toFixed(2)))+"%",1),r("div",U,"偏移: "+u(e.keyOffset)+" / "+u(e.PianoConstant.KEY_COUNT),1),r("div",Y,"八度音程: C"+u(e.octave),1),T(r("div",{class:"desc pro2"}," 按下: "+u(e.keyPressedPC.join(" ")),513),[[f,e.keyPressedPC.length>0]])]),r("div",H,[i(" 音色： "),T(r("select",{"onUpdate:modelValue":a[0]||(a[0]=a=>e.selectedToneType=a)},[(s(!0),o(C,null,P(e.ToneTypesOptions,((e,a)=>(s(),o("option",{key:a,value:e.value,disabled:e.isMP3},u(e.label),9,V)))),128))],512),[[E,e.selectedToneType]])])]),r("div",W,[(s(!0),o(C,null,P(e.miniKeys,((a,l)=>(s(),o("div",{ref_for:!0,ref:"miniKeyboardOctavesRef",key:l,class:c(["octave",{active:l===e.octave}])},[(s(!0),o(C,null,P(a,((a,t)=>(s(),k(v,{small:"",key:t,label:a.label,"extra-label":l.toString(),"key-type":1===a.label.length?e.KeyType.WHITE:e.KeyType.BLACK,onOnPress:l=>e.handleMiniKeyboardPress(a.realIndex+1),onOnRelease:l=>e.stopTone(a.realIndex+1)},null,8,["label","extra-label","key-type","onOnPress","onOnRelease"])))),128))],2)))),128))],512),r("div",j,[(s(!0),o(C,null,P(e.MainKeyboardKeys,((a,l)=>(s(),k(v,{key:l,label:a.label,"key-type":a.type,active:-1!==e.keyPressedPC.indexOf(a.label),onOnPress:a=>e.handleMainKeyboardPress(l),onOnRelease:a=>e.stopTone(l)},null,8,["label","key-type","active","onOnPress","onOnRelease"])))),128))]),r("div",q,[(s(!0),o(C,null,P(e.ControlKeys,((a,l)=>(s(),k(v,{key:l,label:a.label,"key-type":a.type,"extra-label":a.extraLabel,active:-1!==e.keyPressedPC.indexOf(a.label),onOnPress:l=>e.setSettings(a.label)},null,8,["label","key-type","extra-label","active","onOnPress"])))),128))])])],512)}],["__scopeId","data-v-ca4b928c"]]);export{Z as default};
