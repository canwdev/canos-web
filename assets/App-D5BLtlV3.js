var e=Object.defineProperty,a=(a,t,o)=>((a,t,o)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[t]=o)(a,"symbol"!=typeof t?t+"":t,o);import{aa as t,d as o,r as i,N as l,aI as s,y as r,O as d,aC as n,a$ as c,q as u,c as v,b as m,s as h,a as p,l as g,aY as y,m as b,F as f,j as w,h as k,b0 as R,k as _}from"./index-CQGI0j3m.js";import{u as C}from"./use-cursor-CVbmD1GN.js";class S{constructor(e){a(this,"videoElement"),a(this,"mediaRecorder"),a(this,"recordedChunks"),this.videoElement=e,this.mediaRecorder=null,this.recordedChunks=[],console.log("[VideoRecorder]",this)}start(){const e=this.videoElement.srcObject;this.mediaRecorder=new MediaRecorder(e,{audioBitsPerSecond:32e4,videoBitsPerSecond:8e6,mimeType:"video/webm"}),this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.recordedChunks.push(e.data)},this.mediaRecorder.onstop=()=>{console.log("record stop",this.mediaRecorder);const e=new Blob(this.recordedChunks,{type:"video/webm"}),a=URL.createObjectURL(e),o=document.createElement("a");o.href=a,o.download=`record_${t().format("YYYY-MM-DD_HH-mm-ss")}.webm`,o.click(),this.mediaRecorder=null},this.recordedChunks=[],this.mediaRecorder.start(10),console.log("record start",this.mediaRecorder)}stop(){this.mediaRecorder&&this.mediaRecorder.stop()}}const D={class:"action-bar-wrap"},E={class:"action-bar-side"},I={for:"videoSelect"},M=m("span",null,"Video:",-1),U=["value"],j={for:"audioSelect"},Y=m("span",null,"Audio:",-1),x=["value"],O={for:"toggleControls",title:"Toggle video element controls"},H=m("span",null,"Controls",-1),L={class:"action-bar-side right"},V=m("a",{href:"https://github.com/canwdev/web-mediadevices-player",target:"_blank",title:"Github"},"ℹ️",-1),B=["controls"],T=o({__name:"App",setup(e){const a=i(!1),o=l("ls_key_is_show_controls",!1),T=i([]),A=i(),P=l("ls_key_video_device_id",""),$=l("ls_key_audio_device_id",""),F=l("ls_key_video_config",{}),G=s(),W=(e,a)=>e.filter((e=>e.kind===a&&!!e.deviceId)),q=r((()=>W(T.value,"videoinput"))),z=r((()=>W(T.value,"audioinput"))),N=async()=>{try{a.value=!0,T.value=await async function(){var e;if(null==(e=navigator.mediaDevices)?void 0:e.enumerateDevices)return await navigator.mediaDevices.enumerateDevices();throw new Error("enumerateDevices() not supported.")}()}catch(e){console.error(e),alert("Error: "+e.message)}finally{a.value=!1}},J=()=>{navigator.mediaDevices.ondevicechange=async()=>{await N()}},K=s(),Q=s();C(Q,(({el:e,isShow:a})=>{const t=K.value;a?(e.style.cursor="",t.classList.add("visible")):(e.style.cursor="none",t.classList.remove("visible"))}),3e3),d((async()=>{try{if(P.value||$.value)return await X(),await N(),void J();try{G.value=await navigator.mediaDevices.getUserMedia({audio:!0}),ee()}catch(e){console.warn("getUserMedia audio Error:",e)}try{G.value=await navigator.mediaDevices.getUserMedia({video:!0}),ee()}catch(e){console.warn("getUserMedia video Error:",e)}await N(),J()}catch(e){console.error(e),alert("Error: "+e.message)}})),n((()=>{ee()}));const X=async()=>{try{a.value=!0;const t=P.value,o=$.value;let i;if(t)if(F.value&&F.value.deviceId===t)i=F.value;else{const e=q.value.find((e=>e.deviceId===t));if(console.log(e),e){const a=e.getCapabilities();i=F.value={deviceId:a.deviceId,height:a.height.max,width:a.width.max,frameRate:a.frameRate.max}}else i={deviceId:t}}var e={audio:!!o&&{deviceId:o,autoGainControl:!1,echoCancellation:!1,noiseSuppression:!1},video:i};const l=await navigator.mediaDevices.getUserMedia(e);G.value=l;const s=A.value;s.srcObject=l,s.onloadedmetadata=()=>{s.play()}}catch(t){console.error(t),alert("Error: "+t.message)}finally{a.value=!1}},Z=()=>{ee(),X()},ee=()=>{const e=A.value;e.pause(),e.srcObject=null;const a=G.value;if(!a)return;a.getTracks().forEach((e=>{"live"==e.readyState&&e.stop()}))},ae=()=>{ee(),P.value="",$.value="",F.value=null},{toggle:te}=c(Q),oe=async()=>{try{a.value=!0,ee();const e=await navigator.mediaDevices.getDisplayMedia({video:{displaySurface:"window"},audio:!0});G.value=e;const t=A.value;t.srcObject=e,t.onloadedmetadata=()=>{t.play()}}catch(e){console.error(e),alert("Error: "+e.message)}finally{a.value=!1}},ie=()=>{!function(e){const a=document.createElement("canvas");a.width=e.videoWidth,a.height=e.videoHeight,a.getContext("2d").drawImage(e,0,0,e.videoWidth,e.videoHeight);const o=a.toDataURL("image/png"),i=document.createElement("a");i.download=`screenshot_${t().format("YYYY-MM-DD_HH-mm-ss")}.png`,i.href=o,i.click()}(A.value)};let le=i(null);return d((()=>{le.value=new S(A.value)})),(e,t)=>(u(),v("div",{ref_key:"rootRef",ref:Q,class:"web-mediadevices-player"},[m("div",{class:h(["loading-layer",{visible:a.value}])},"Loading...",2),m("div",D,[m("div",{ref_key:"actionBarRef",ref:K,class:h(["action-bar font-emoji",{visible:!p(P)&&!p($)}])},[m("div",E,[m("label",I,[M,g(m("select",{title:"Video",id:"videoSelect","onUpdate:modelValue":t[0]||(t[0]=e=>b(P)?P.value=e:null)},[(u(!0),v(f,null,w(q.value,(e=>(u(),v("option",{key:e.deviceId,value:e.deviceId},k(e.label),9,U)))),128))],512),[[y,p(P)]])]),m("label",j,[Y,g(m("select",{name:"Audio",id:"audioSelect","onUpdate:modelValue":t[1]||(t[1]=e=>b($)?$.value=e:null)},[(u(!0),v(f,null,w(z.value,(e=>(u(),v("option",{key:e.deviceId,value:e.deviceId},k(e.label),9,x)))),128))],512),[[y,p($)]])]),m("button",{onClick:Z},"▶Start"),m("button",{onClick:ee},"⏹Stop"),m("button",{onClick:ae},"🛑Reset"),m("label",O,[g(m("input",{id:"toggleControls",type:"checkbox","onUpdate:modelValue":t[2]||(t[2]=e=>b(o)?o.value=e:null),title:"Show Controls"},null,512),[[R,p(o)]]),H]),m("button",{onClick:oe,title:"Capture Screen"},"🖥️Capture..."),m("button",{onClick:ie,title:"Take a photo"},"📷Screenshot"),p(le)?(u(),v(f,{key:0},[Boolean(p(le).mediaRecorder)?(u(),v("button",{key:0,onClick:t[3]||(t[3]=e=>p(le).stop()),title:"Save record",style:{background:"#f44336"}}," 📹Save ")):(u(),v("button",{key:1,onClick:t[4]||(t[4]=e=>p(le).start()),title:"Record canvas"},"📹Record..."))],64)):_("",!0)]),m("div",L,[m("button",{onClick:t[5]||(t[5]=(...e)=>p(te)&&p(te)(...e))},"📺Fullscreen"),V])],2)]),m("video",{ref_key:"videoRef",ref:A,id:"videoId",autoplay:"",playsinline:"",controls:p(o)},null,8,B)],512))}});export{T as default};
